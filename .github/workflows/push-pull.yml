name: push-pull

on:
  pull_request:
    types:
      - closed

  push:
    branches:
      - master

  workflow_dispatch:

jobs:
  if_merged:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        github-server-url: https://github.com/dogusyuksel/embedded_docker
        lfs: true

    - name: free space
      run: |
        df . -h
        sudo docker rmi $(docker image ls -aq) >/dev/null 2>&1 || true
        sudo rm -rf \
            /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup \
            /usr/lib/jvm || true
        echo "some directories deleted"
        sudo apt install aptitude -y >/dev/null 2>&1
        sudo aptitude purge aria2 ansible azure-cli shellcheck rpm xorriso zsync \
            esl-erlang firefox gfortran-8 gfortran-9 google-chrome-stable \
            google-cloud-sdk imagemagick \
            libmagickcore-dev libmagickwand-dev libmagic-dev ant ant-optional kubectl \
            mercurial apt-transport-https mono-complete libmysqlclient \
            unixodbc-dev yarn chrpath libssl-dev libxft-dev \
            libfreetype6 libfreetype6-dev libfontconfig1 libfontconfig1-dev \
            snmp pollinate libpq-dev postgresql-client powershell ruby-full \
            sphinxsearch subversion mongodb-org azure-cli microsoft-edge-stable \
            -y -f >/dev/null 2>&1
        sudo aptitude purge google-cloud-sdk -f -y >/dev/null 2>&1
        sudo aptitude purge microsoft-edge-stable -f -y >/dev/null 2>&1 || true
        sudo apt purge microsoft-edge-stable -f -y >/dev/null 2>&1 || true
        sudo aptitude purge '~n ^mysql' -f -y >/dev/null 2>&1
        sudo aptitude purge '~n ^php' -f -y >/dev/null 2>&1
        sudo aptitude purge '~n ^dotnet' -f -y >/dev/null 2>&1
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        echo "some packages purged"    echo -e "Removing unnecessary packages"
        sudo apt-get autoremove -y >/dev/null 2>&1
        sudo apt-get autoclean -y >/dev/null 2>&1
        echo -e "Cleaning package cache"
        sudo apt-get clean >/dev/null 2>&1
        echo -e "Removing orphaned packages"
        sudo deborphan | xargs -r sudo apt-get -y remove >/dev/null 2>&1
        echo -e "Cleaning thumbnail cache"
        rm -rf ~/.cache/thumbnails/*
        echo -e "Cleaning system temporary files"
        sudo rm -rf /tmp/* /var/tmp/*
        echo -e "Cleaning journal logs (optional, keep last 2 weeks)"
        sudo journalctl --vacuum-time=2weeks
        echo -e "Cleaning old log files"
        sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
        df . -h

    - uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          dockerfile:
            - 'Dockerfile'

    - name: Login to Docker Hub
      if: steps.changes.outputs.dockerfile == 'true'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Set up Docker Buildx
      if: steps.changes.outputs.dockerfile == 'true'
      uses: docker/setup-buildx-action@v3

    - name: Build Project Docker
      if: steps.changes.outputs.dockerfile == 'true'
      uses: docker/build-push-action@v5
      with:
        load: true
        tags: |
          ${{ secrets.DOCKER_REPO }}:master
        context: .
        file: Dockerfile
        pull: true
        push: false
        provenance: false

    - name: Push Project Docker
      if: steps.changes.outputs.dockerfile == 'true'
      uses: docker/build-push-action@v5
      with:
        tags: |
          ${{ secrets.DOCKER_REPO }}:master
        context: .
        file: Dockerfile
        pull: false
        push: true
        provenance: false
